<script type="text/javascript">function inprogress(elementid){document.getElementById(elementid).className = "inprogress";}</script>
<style>.inputfield{margin-left:4px}.btn{margin-top:-1px;margin-left:4px;padding:3px}.btn2{margin-left:10px}.btn3{margin-left:25px}.statusmsgwrapper{padding-left:294px;}:root{--cti-scanstat-main-color:red;--cti-scanstat-text-shadow-color:rgba(0,0,0,0)}.status,.lmsscan{color:var(--cti-scanstat-main-color) !important;font-size:120%}.success{color:green !important;}.scanstatus:after{font-size:180%;content:' .';animation:dots 1.8s steps(5,end)infinite}@keyframes dots{0%,20%{color:var(--cti-scanstat-text-shadow-color);text-shadow:.25em 0 0 var(--cti-scanstat-text-shadow-color),.5em 0 0 var(--cti-scanstat-text-shadow-color)}40%{color:var(--cti-scanstat-main-color);text-shadow:.25em 0 0 var(--cti-scanstat-text-shadow-color),.5em 0 0 var(--cti-scanstat-text-shadow-color)}60%{text-shadow:.25em 0 0 var(--cti-scanstat-main-color),.5em 0 0 var(--cti-scanstat-text-shadow-color)}80%,100%{text-shadow:.25em 0 0 var(--cti-scanstat-main-color),.5em 0 0 var(--cti-scanstat-main-color)}}#scanProgressPercentageWrapper{display:none;width:80px;margin: 8px 0 10px 294px;background-color:gray;}#scanProgressPercentageBar{width:0%;height:4px;background-color:#04AA6D;}@-webkit-keyframes Pulse{from{color:#630030;-webkit-text-shadow:0 0 2px transparent}50%{color:#e33100;-webkit-text-shadow:0 0 5px #e33100}to{color:#630030;-webkit-text-shadow:0 0 2px transparent}}@keyframes Pulse{from{color:#630030;text-shadow:0 0 2px transparent}50%{color:#e33100;text-shadow:0 0 5px #e33100}to{color:#630030;text-shadow:0 0 2px transparent}}.inprogress{padding-left:15px;-webkit-animation-name:Pulse;animation-name:Pulse;-webkit-animation-duration:2s;animation-duration:2s;-webkit-animation-iteration-count:infinite;animation-iteration-count:infinite}.hide{visibility:hidden;}.githublink{padding-left:22px;}</style>

[% page = "PLUGIN_CUSTOMTAGIMPORTER" %]
[% PROCESS settings/header.html %]
[% PROCESS plugins/CustomTagImporter/settings/subpage_chooser.html %]

	<div class="statusmsgwrapper">
		<p id="statusmsg" class="status"></p>
	</div>
	<div id="scanProgressPercentageWrapper">
		<div id="scanProgressPercentageBar"></div>
	</div>
	<div id="lmsscanstatus" class="statusmsgwrapper lmsscan[% IF !activelmsscan %] hide[% END %]">[% "PLUGIN_CUSTOMTAGIMPORTER_LMSSCANINPROGRESS" | string %]</div>

[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS" desc="" %]
	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TAGSTOSCAN" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TAGSTOSCAN_DESC" %]
		<input class="inputfield" type="text" class="stdedit" name="pref_customtags" id="customtags" value="[% prefs.customtags %]" size="50">
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_SINGLECUSTOMTAGS" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_SINGLECUSTOMTAGS_DESC" %]
		<input class="inputfield" type="text" class="stdedit" name="pref_singlecustomtags" id="singlecustomtags" value="[% prefs.singlecustomtags %]" size="50">
	[% END %]
	<br>

	[% IF titleformatOptions.size > 0 %]
	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TITLEFORMATS" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TITLEFORMATS_DESC" %]
		<table width="100%">
			<tr><td>
			<select class="stdedit" name="pref_selectedtitleformats" multiple>
			[% FOREACH option = titleformatOptions.keys.sort %]
			[% formatname = titleformatOptions.$option %]
				<option [% IF selectedtitleformats.$formatname %]selected [% END %]value="[% titleformatOptions.$option %]">[% titleformatOptions.$option %]</option>
			[% END %]
			</select>
			</td></tr>
		</table>
	[% END %]
	[% END %]


	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TAGMAPPING" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_TAGMAPPING_DESC" %]
		<input class="inputfield" type="text" class="stdedit" name="pref_customtagsmapping" id="customtagsmapping" value="[% prefs.customtagsmapping %]" size="60">
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_SORTTAGMAPPING" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_SORTTAGMAPPING_DESC" %]
		<input class="inputfield" type="text" class="stdedit" name="pref_customsorttags" id="customsorttags" value="[% prefs.customsorttags %]" size="60">
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_RAWMP3TAGS" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_RAWMP3TAGS_DESC" %]
	<select class="stdedit" name="pref_customtagrawmp3tags" id="customtagrawmp3tags">
		<option [% IF NOT prefs.customtagrawmp3tags %]selected [% END %]value="0">[% 'NO' | getstring %]</option>
		<option [% IF prefs.customtagrawmp3tags %]selected [% END %]value="1">[% 'YES' | getstring %]</option>
	</select>
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_DUMPTAGNAMES" desc="PLUGIN_CUSTOMTAGIMPORTER_CUSTOMTAGS_DUMPTAGNAMES_DESC" %]
	<select class="stdedit" name="pref_dumptagnames" id="dumptagnames">
		<option [% IF NOT prefs.dumptagnames %]selected [% END %]value="0">[% 'NO' | getstring %]</option>
		<option [% IF prefs.dumptagnames %]selected [% END %]value="1">[% 'YES' | getstring %]</option>
	</select>
	[% END %]
	<br>

[% END %]

<br>

[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS" desc="" %]
	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_TAGSTOSCAN" desc="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_TAGSTOSCAN_DESC" %]
		<input class="inputfield" type="text" class="stdedit" name="pref_ratingtags" id="ratingtags" value="[% prefs.ratingtags %]" size="40">
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_MAXVAL" desc="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_MAXVAL_DESC" %]
		<input type="text" class="stdedit sliderInput_5_255_1" name="pref_ratingtagmax" id="ratingtagmax" value="[% prefs.ratingtagmax %]" size="3">
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_WRITETOLMSDB" desc="PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_WRITETOLMSDB_DESC" %]
	<select class="stdedit" name="pref_writeratingstodb" id="writeratingstodb">
		<option [% IF NOT prefs.writeratingstodb %]selected [% END %]value="0">[% 'NO' | getstring %]</option>
		<option [% IF prefs.writeratingstodb %]selected [% END %]value="1">[% 'YES' | getstring %]</option>
	</select>
	[% END %]
	<br>

[% END %]

<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_AUTO_RESCAN" desc="PLUGIN_CUSTOMTAGIMPORTER_AUTO_RESCAN_DESC" %]
		<select class="stdedit" name="pref_autorescan" id="autorescan">
			<option [% IF NOT prefs.autorescan %]selected [% END %]value="0">[% 'NO' | getstring %]</option>
			<option [% IF prefs.autorescan %]selected [% END %]value="1">[% 'YES' | getstring %]</option>
		</select>
	[% END %]
	<br>

	[% WRAPPER setting title="PLUGIN_CUSTOMTAGIMPORTER_SCANNING" desc="PLUGIN_CUSTOMTAGIMPORTER_SCANNING_DESC" %]
		<input class="btn" id="scan" name="rescan" type="submit" class="stdclick" value="[% "PLUGIN_CUSTOMTAGIMPORTER_SCANNING_SCAN_BUTTON" | string %]"[% IF activelmsscan || activectiscan %] disabled[% END %]><input class="btn btn2" id="abort" name="abortscan" type="submit" class="stdclick" value="[% "PLUGIN_CUSTOMTAGIMPORTER_SCANNING_ABORT_BUTTON" | string %]"[% IF activelmsscan || activectiscan %] disabled[% END %]>
		<input class="btn btn3[% IF ratedtrackcount %] hide[% END %]" id="reset" name="resetratingsto_ctivalues" type="submit" class="stdclick" onclick="inprogress('resetratingstoctivalues_status');" value="[% "PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_RESETLMSDBTOCTIVALUES" | string %]"[% IF activelmsscan || activectiscan %] disabled[% END %]>
		<span class='hide' id='resetratingstoctivalues_status'>[% "PLUGIN_CUSTOMTAGIMPORTER_RATINGTAGS_RESETLMSDBTOCTIVALUES_INPROGRESS" | string %]</span>
	[% END %]
<br><br>

[% PROCESS settings/footer.html %]

<script type="text/javascript">
	var scanStatus;

	function getPrefVal(prefName, val) {
		const serverjsonurl = "[% squeezebox_server_jsondatareq %]";
		let prefValue = val ? val : '?'; // if (quoted) val -> SET pref val
		let vsBody = '';

		if (prefName == 'rescanprogress') {
			vsBody = JSON.stringify({
				id: 1,
				method: 'slim.request',
				params: ['', ['rescanprogress', 'rescan']]
			});
		} else {
			vsBody = JSON.stringify({
				id: 1,
				method: 'slim.request',
				params: ['', ['pref', 'plugin.customtagimporter:' + prefName, prefValue]]
			});
		}

		async function getPrefValFromServer() {
			let response = await fetch(serverjsonurl, {
				method: "post",
				headers: { "Content-Type": "application/json", "Origin": window.location.hostname },
				body: vsBody
			});
			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			return await response.json();
		}

		getPrefValFromServer().then((jsonData) => {
			console.log('jsonData = ' + JSON.stringify(jsonData));
			if (prefValue == '?') {
				if (prefName == 'rescanprogress') {
					console.log('value for "rescan" = ' + jsonData.result["rescan"]);
				} else {
					console.log('value for "' + prefName + '" = ' + Object.values(jsonData.result)[0]);
				}
			}

			if (prefName == 'rescanprogress') {
				if (jsonData.result["rescan"] == 1) {
					console.log('LMS scan in progress');
					document.getElementById('scan').disabled = true;
					document.getElementById('abort').disabled = true;
					document.getElementById('reset').disabled = true;
				} else {
					console.log('No LMS scan in progress');
					document.getElementById('scan').disabled = false;
					document.getElementById('abort').disabled = false;
					document.getElementById('reset').disabled = false;
					document.getElementById('lmsscanstatus').classList.add('hide');
					getPrefVal('scanningInProgress');
				}
			} else if (prefName == 'scanningInProgress') {
				if (Object.values(jsonData.result)[0] == 0) {
					console.log('No CTI scan in progress');
					document.getElementById('scan').disabled = false;
					document.getElementById('abort').disabled = false;
					document.getElementById('reset').disabled = false;
					document.getElementById('statusmsg').innerHTML = '';
					document.getElementById('statusmsg').classList.remove('success', 'scanstatus');
					document.getElementById('scanProgressPercentageWrapper').style.display = 'none';
					clearInterval(scanStatus);
					getPrefVal('scanResult');
				} else if (Object.values(jsonData.result)[0] == 1) {
					console.log('CTI scan in progress');
					document.getElementById('scan').disabled = true;
					document.getElementById('reset').disabled = true;
					document.getElementById('statusmsg').innerHTML = 'Scanning';
					document.getElementById('statusmsg').classList.remove('success');
					document.getElementById('statusmsg').classList.add('scanstatus');
					document.getElementById('scanProgressPercentageWrapper').style.display = 'block';
					getPrefVal('scanprogresspercentage');
				}
			} else if (prefName == 'scanResult') {
				if (Object.values(jsonData.result)[0] == 1) {
					console.log('CTI scan completed - success');
					document.getElementById('statusmsg').classList.add('success');
					document.getElementById('statusmsg').innerHTML = 'Scan completed - success';
					setTimeout(getPrefVal, 3000, 'scanResult', '0');
				} else if (Object.values(jsonData.result)[0] == 2) {
					console.log('CTI scan aborted');
					document.getElementById('statusmsg').innerHTML = 'Scan aborted';
					setTimeout(getPrefVal, 3000, 'scanResult', '0');
				} else if (Object.values(jsonData.result)[0] == 3) {
					console.log('CTI scan completed with errors');
					document.getElementById('statusmsg').innerHTML = 'Scan completed with errors. Check server log for details.';
					setTimeout(getPrefVal, 3000, 'scanResult', '0');
				} else if (Object.values(jsonData.result)[0] == 4) {
					console.log('CTI scan not possible - no tags specified');
					document.getElementById('statusmsg').innerHTML = 'Cannot scan - no tags specified to search for.';
					setTimeout(getPrefVal, 3000, 'scanResult', '0');
				}
			} else if (prefName == 'scanprogresspercentage') {
				let scanProgressPercentage = Object.values(jsonData.result)[0];
				console.log('scan progess in percent = ' + scanProgressPercentage);
				var elem = document.getElementById("scanProgressPercentageBar");
				elem.style.width = scanProgressPercentage + "%";
			}
		}).catch(function(error) {
			document.getElementById('statusmsg').innerHTML = '';
			document.getElementById('statusmsg').classList.remove('success', 'scanstatus');
			clearInterval(scanStatus);
			console.log(error);
		});
	}

	window.addEventListener("load",() => {
		// get status right away, interval starts with delay
		getScanStatus();

		scanStatus = setInterval(getScanStatus, 10000);

		function getScanStatus() {
			getPrefVal('rescanprogress');
		}
	});
</script>